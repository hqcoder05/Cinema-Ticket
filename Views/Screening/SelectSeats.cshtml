@model Cinema_ticket.Models.Movie.Screening

@{
    ViewData["Title"] = "Ch·ªçn Gh·∫ø";
}

<div class="container" style="margin-top: 30px; margin-bottom: 40px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; border-radius: 10px; margin-bottom: 40px;">
        <h1 style="font-size: 36px; font-weight: bold; margin-bottom: 20px;">Ch·ªçn Gh·∫ø Ng·ªìi</h1>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; font-size: 14px;">
            <div>
                <p style="opacity: 0.8; margin-bottom: 5px;">üé¨ PHIM</p>
                <p style="font-size: 16px; font-weight: bold;">@Model.Movie?.Title</p>
            </div>
            <div>
                <p style="opacity: 0.8; margin-bottom: 5px;">üìÖ NG√ÄY GI·ªú</p>
                <p style="font-size: 16px; font-weight: bold;">@Model.ScreeningDateTime.ToString("dd/MM/yyyy HH:mm")</p>
            </div>
            <div>
                <p style="opacity: 0.8; margin-bottom: 5px;">üè¢ R·∫†P</p>
                <p style="font-size: 16px; font-weight: bold;">@Model.Screen?.Cinema?.Name - @Model.Screen?.ScreenName</p>
            </div>
            <div>
                <p style="opacity: 0.8; margin-bottom: 5px;">üí∞ GI√Å V√â</p>
                <p style="font-size: 16px; font-weight: bold;">@Model.Price.ToString("C")</p>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Gh·∫ø -->
        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 30px; text-align: center;">S∆° ƒê·ªì Gh·∫ø Ng·ªìi</h2>
            
            <div style="background: linear-gradient(135deg, #333 0%, #555 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 30px; text-align: center; font-weight: bold; letter-spacing: 4px;">
                M√ÄN H√åNH
            </div>

            <div style="display: grid; gap: 20px; margin-bottom: 30px;" id="seatsContainer">
                <!-- Gh·∫ø s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JavaScript -->
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; background: #90caf9; border-radius: 3px;"></div>
                    <span style="font-size: 12px; color: #666;">Gh·∫ø Tr·ªëng</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; background: #ccc; border-radius: 3px;"></div>
                    <span style="font-size: 12px; color: #666;">Gh·∫ø ƒê√£ ƒê·∫∑t</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 3px;"></div>
                    <span style="font-size: 12px; color: #666;">Gh·∫ø Ch·ªçn</span>
                </div>
            </div>
        </div>

        <!-- T√≥m T·∫Øt ƒê∆°n H√†ng -->
        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: fit-content;">
            <h2 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 20px;">T√≥m T·∫Øt ƒê∆°n H√†ng</h2>

            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
                <p style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 5px;">PHIM</p>
                <p style="color: #333; font-size: 14px;">@Model.Movie?.Title</p>
            </div>

            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
                <p style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 5px;">NG√ÄY GI·ªú</p>
                <p style="color: #333; font-size: 14px;">@Model.ScreeningDateTime.ToString("dd/MM/yyyy HH:mm")</p>
            </div>

            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
                <p style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 8px;">GH·∫æ ƒê√É CH·ªåN</p>
                <div id="selectedSeatsDisplay" style="color: #667eea; font-weight: bold; min-height: 30px;">
                    <p style="color: #999;">Ch∆∞a ch·ªçn gh·∫ø n√†o</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div>
                    <p style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 5px;">S·ªê GH·∫æ</p>
                    <p id="seatCountDisplay" style="color: #333; font-size: 20px; font-weight: bold;">0</p>
                </div>
                <div style="text-align: right;">
                    <p style="color: #999; font-size: 12px; font-weight: bold; margin-bottom: 5px;">T·ªîNG TI·ªÄN</p>
                    <p id="totalPriceDisplay" style="color: #ff6b6b; font-size: 24px; font-weight: bold;">@Model.Price.ToString("C0")</p>
                </div>
            </div>

            <button onclick="proceedToCheckout()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.3s; margin-bottom: 10px;"
                    onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                Ti·∫øp T·ª•c Thanh To√°n ‚Üí
            </button>

            <button onclick="goBack()" style="width: 100%; background: #f5f5f5; color: #333; border: 1px solid #ddd; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
                    onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">
                ‚Üê Quay L·∫°i
            </button>
        </div>
    </div>
</div>

<script>
    const price = @Model.Price;
    const totalSeats = @Model.TotalSeats;
    const screeningId = @Model.Id;
    const availableSeats = @Model.AvailableSeats;
    let selectedSeats = [];

    // T·∫°o s∆° ƒë·ªì gh·∫ø
    function initializeSeats() {
        const container = document.getElementById('seatsContainer');
        const rows = 8; // 8 h√†ng
        const seatsPerRow = Math.ceil(totalSeats / rows);
        
        for (let i = 0; i < rows; i++) {
            let rowDiv = document.createElement('div');
            rowDiv.style.display = 'grid';
            rowDiv.style.gridTemplateColumns = `repeat(${seatsPerRow}, 1fr)`;
            rowDiv.style.gap = '8px';
            rowDiv.style.alignItems = 'center';

            let rowLabel = document.createElement('div');
            rowLabel.style.gridColumn = '1';
            rowLabel.textContent = String.fromCharCode(65 + i);
            rowLabel.style.fontWeight = 'bold';
            rowLabel.style.color = '#667eea';
            rowLabel.style.fontSize = '12px';
            rowLabel.style.textAlign = 'center';

            for (let j = 1; j <= seatsPerRow; j++) {
                const seatNumber = i * seatsPerRow + j;
                if (seatNumber > totalSeats) break;

                let seat = document.createElement('div');
                seat.className = 'seat';
                seat.id = `seat_${seatNumber}`;
                seat.textContent = j;
                seat.style.width = '30px';
                seat.style.height = '30px';
                seat.style.display = 'flex';
                seat.style.alignItems = 'center';
                seat.style.justifyContent = 'center';
                seat.style.borderRadius = '3px';
                seat.style.background = '#90caf9';
                seat.style.color = '#333';
                seat.style.fontSize = '12px';
                seat.style.fontWeight = 'bold';
                seat.style.cursor = 'pointer';
                seat.style.transition = 'all 0.3s ease';
                seat.style.userSelect = 'none';

                seat.onclick = function() {
                    toggleSeat(seat, seatNumber);
                };

                rowDiv.appendChild(seat);
            }

            container.appendChild(rowDiv);
        }
    }

    function toggleSeat(element, seatNumber) {
        if (element.style.background === 'rgb(204, 204, 204)') {
            // Gh·∫ø ƒë√£ ƒë·∫∑t - kh√¥ng th·ªÉ ch·ªçn
            return;
        }

        if (element.style.background === 'rgb(255, 107, 107)') {
            // B·ªè ch·ªçn gh·∫ø
            element.style.background = '#90caf9';
            selectedSeats = selectedSeats.filter(s => s !== seatNumber);
        } else {
            // Ch·ªçn gh·∫ø
            element.style.background = '#ff6b6b';
            selectedSeats.push(seatNumber);
        }

        updateOrderSummary();
    }

    function updateOrderSummary() {
        const count = selectedSeats.length;
        document.getElementById('seatCountDisplay').textContent = count;
        document.getElementById('totalPriceDisplay').textContent = (price * count).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

        if (count > 0) {
            const seatLabels = selectedSeats.sort((a, b) => a - b).map(s => {
                const row = Math.floor((s - 1) / 10);
                const col = (s - 1) % 10 + 1;
                return String.fromCharCode(65 + row) + col;
            });
            document.getElementById('selectedSeatsDisplay').innerHTML = '<strong>' + seatLabels.join(', ') + '</strong>';
        } else {
            document.getElementById('selectedSeatsDisplay').innerHTML = '<p style="color: #999;">Ch∆∞a ch·ªçn gh·∫ø n√†o</p>';
        }
    }

    function proceedToCheckout() {
        if (selectedSeats.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gh·∫ø!');
            return;
        }
        
        // L∆∞u gh·∫ø v√†o session ho·∫∑c g·ª≠i ƒë·∫øn server
        // ·ªû ƒë√¢y t·∫°m th·ªùi alert, sau s·∫Ω th√™m API
        alert(`ƒê√£ ch·ªçn ${selectedSeats.length} gh·∫ø: ${selectedSeats.join(', ')}`);
        // Chuy·ªÉn ƒë·∫øn trang thanh to√°n
        window.location.href = `/Screening/Checkout/${screeningId}?seats=${selectedSeats.join(',')}`;
    }

    function goBack() {
        window.history.back();
    }

    // Kh·ªüi t·∫°o khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', function() {
        initializeSeats();
        updateOrderSummary();
    });
</script>

<style>
    .seat:hover {
        transform: scale(1.1);
    }
</style>
